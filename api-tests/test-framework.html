<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoped API Test Framework</title>
    <script src="../config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .test-title { font-size: 18px; font-weight: bold; }
        .test-btn { padding: 8px 16px; background: #007cbf; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .test-btn:hover { background: #005a8b; }
        .test-btn:disabled { background: #ccc; cursor: not-allowed; }
        .result { margin-top: 15px; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .coords { margin: 10px 0; }
        .coords input { padding: 5px; margin: 0 5px; width: 100px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Scoped API Test Framework</h1>
        <p>Test individual APIs before integrating into the main app</p>
        
        <div class="coords">
            <label>Test Coordinates:</label>
            <input type="number" id="testLat" value="28.6" step="0.0001" placeholder="Latitude">
            <input type="number" id="testLng" value="77.2" step="0.0001" placeholder="Longitude">
        </div>
        
        <!-- Healthcare API Test -->
        <div class="test-card">
            <div class="test-header">
                <div class="test-title">üè• Healthcare Facilities (Overpass API)</div>
                <button class="test-btn" onclick="testHealthcare()">Test</button>
            </div>
            <div>Tests: Hospitals, clinics, pharmacies within 2km radius</div>
            <div id="healthcare-result"></div>
        </div>
        
        <!-- Education API Test -->
        <div class="test-card">
            <div class="test-header">
                <div class="test-title">üè´ Education Facilities (Overpass API)</div>
                <button class="test-btn" onclick="testEducation()">Test</button>
            </div>
            <div>Tests: Schools, colleges, universities, libraries within 2km radius</div>
            <div id="education-result"></div>
        </div>
        
        <!-- Transport API Test -->
        <div class="test-card">
            <div class="test-header">
                <div class="test-title">üöå Public Transport (Overpass API)</div>
                <button class="test-btn" onclick="testTransport()">Test</button>
            </div>
            <div>Tests: Bus stops, railway stations within 1.5km radius</div>
            <div id="transport-result"></div>
        </div>
        
        <!-- Services API Test -->
        <div class="test-card">
            <div class="test-header">
                <div class="test-title">üè¶ Essential Services (Overpass API)</div>
                <button class="test-btn" onclick="testServices()">Test</button>
            </div>
            <div>Tests: Banks, ATMs, markets, police stations within 1.5km radius</div>
            <div id="services-result"></div>
        </div>
        
        <!-- Weather API Test -->
        <div class="test-card">
            <div class="test-header">
                <div class="test-title">üå§Ô∏è Weather Data (OpenWeatherMap)</div>
                <button class="test-btn" onclick="testWeather()">Test</button>
            </div>
            <div>Tests: Current weather, temperature, humidity (requires API key)</div>
            <div id="weather-result"></div>
        </div>
        
        <!-- Elevation API Test -->
        <div class="test-card">
            <div class="test-header">
                <div class="test-title">‚õ∞Ô∏è Elevation Data (Open-Elevation)</div>
                <button class="test-btn" onclick="testElevation()">Test</button>
            </div>
            <div>Tests: Elevation above sea level</div>
            <div id="elevation-result"></div>
        </div>
        
        <h2>üöÄ Phase 2 APIs</h2>
        
        <!-- NASA POWER API Test -->
        <div class="test-card">
            <div class="test-header">
                <div class="test-title">‚òÄÔ∏è NASA POWER API</div>
                <button class="test-btn" onclick="testNASAPower()">Test</button>
            </div>
            <div>Tests: Solar radiation, climate data, agricultural metrics</div>
            <div id="nasa-result"></div>
        </div>
        

        
        <!-- Real AQI API Test -->
        <div class="test-card">
            <div class="test-header">
                <div class="test-title">üå¨Ô∏è Real AQI Data (OpenWeatherMap)</div>
                <button class="test-btn" onclick="testRealAQI()">Test</button>
            </div>
            <div>Tests: Real-time air quality from OpenWeatherMap Air Pollution API</div>
            <div id="realaqi-result"></div>
        </div>
        
        <!-- Air Pollution History Test -->
        <div class="test-card">
            <div class="test-header">
                <div class="test-title">üìà Air Pollution History (OpenWeatherMap)</div>
                <button class="test-btn" onclick="testAirPollutionHistory()">Test</button>
            </div>
            <div>Tests: Historical air pollution data (last 7 days)</div>
            <div id="airhistory-result"></div>
        </div>
    </div>

    <script>
        function getCoords() {
            return {
                lat: parseFloat(document.getElementById('testLat').value),
                lng: parseFloat(document.getElementById('testLng').value)
            };
        }
        
        function showResult(elementId, status, message, data = null) {
            const element = document.getElementById(elementId);
            const className = status === 'loading' ? 'loading' : status === 'success' ? 'success' : 'error';
            const content = data ? `${message}\n\nData: ${JSON.stringify(data, null, 2)}` : message;
            element.innerHTML = `<div class="result ${className}">${content}</div>`;
        }
        
        async function testHealthcare() {
            const { lat, lng } = getCoords();
            showResult('healthcare-result', 'loading', 'Testing healthcare facilities...');
            
            try {
                const query = `
                    [out:json][timeout:15];
                    (
                      node["amenity"="hospital"](around:2000,${lat},${lng});
                      node["amenity"="clinic"](around:2000,${lat},${lng});
                      node["amenity"="pharmacy"](around:2000,${lat},${lng});
                    );
                    out;
                `;
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const facilities = {
                    hospitals: data.elements.filter(el => el.tags?.amenity === 'hospital').length,
                    clinics: data.elements.filter(el => el.tags?.amenity === 'clinic').length,
                    pharmacies: data.elements.filter(el => el.tags?.amenity === 'pharmacy').length,
                    total: data.elements.length
                };
                
                showResult('healthcare-result', 'success', 'Healthcare API test successful!', facilities);
            } catch (error) {
                showResult('healthcare-result', 'error', `Healthcare API test failed: ${error.message}`);
            }
        }
        
        async function testEducation() {
            const { lat, lng } = getCoords();
            showResult('education-result', 'loading', 'Testing education facilities...');
            
            try {
                const query = `
                    [out:json][timeout:15];
                    (
                      node["amenity"="school"](around:2000,${lat},${lng});
                      node["amenity"="college"](around:2000,${lat},${lng});
                      node["amenity"="university"](around:2000,${lat},${lng});
                      node["amenity"="library"](around:2000,${lat},${lng});
                    );
                    out;
                `;
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const facilities = {
                    schools: data.elements.filter(el => el.tags?.amenity === 'school').length,
                    colleges: data.elements.filter(el => el.tags?.amenity === 'college').length,
                    universities: data.elements.filter(el => el.tags?.amenity === 'university').length,
                    libraries: data.elements.filter(el => el.tags?.amenity === 'library').length,
                    total: data.elements.length
                };
                
                showResult('education-result', 'success', 'Education API test successful!', facilities);
            } catch (error) {
                showResult('education-result', 'error', `Education API test failed: ${error.message}`);
            }
        }
        
        async function testTransport() {
            const { lat, lng } = getCoords();
            showResult('transport-result', 'loading', 'Testing transport facilities...');
            
            try {
                const query = `
                    [out:json][timeout:15];
                    (
                      node["highway"="bus_stop"](around:1500,${lat},${lng});
                      node["railway"="station"](around:1500,${lat},${lng});
                      node["public_transport"="station"](around:1500,${lat},${lng});
                    );
                    out;
                `;
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const facilities = {
                    busStops: data.elements.filter(el => el.tags?.highway === 'bus_stop').length,
                    stations: data.elements.filter(el => el.tags?.railway === 'station' || el.tags?.public_transport === 'station').length,
                    total: data.elements.length
                };
                
                showResult('transport-result', 'success', 'Transport API test successful!', facilities);
            } catch (error) {
                showResult('transport-result', 'error', `Transport API test failed: ${error.message}`);
            }
        }
        
        async function testServices() {
            const { lat, lng } = getCoords();
            showResult('services-result', 'loading', 'Testing essential services...');
            
            try {
                const query = `
                    [out:json][timeout:15];
                    (
                      node["amenity"="bank"](around:1500,${lat},${lng});
                      node["amenity"="atm"](around:1500,${lat},${lng});
                      node["shop"="supermarket"](around:1500,${lat},${lng});
                      node["amenity"="police"](around:1500,${lat},${lng});
                    );
                    out;
                `;
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const facilities = {
                    banks: data.elements.filter(el => el.tags?.amenity === 'bank').length,
                    atms: data.elements.filter(el => el.tags?.amenity === 'atm').length,
                    markets: data.elements.filter(el => el.tags?.shop === 'supermarket').length,
                    police: data.elements.filter(el => el.tags?.amenity === 'police').length,
                    total: data.elements.length
                };
                
                showResult('services-result', 'success', 'Services API test successful!', facilities);
            } catch (error) {
                showResult('services-result', 'error', `Services API test failed: ${error.message}`);
            }
        }
        
        async function testWeather() {
            const { lat, lng } = getCoords();
            showResult('weather-result', 'loading', 'Testing weather API...');
            
            try {
                const apiKey = API_CONFIG.OPENWEATHER_API_KEY;
                if (!apiKey) {
                    throw new Error('OpenWeatherMap API key not configured in config.js');
                }
                
                const response = await fetch(`${API_CONFIG.ENDPOINTS.OPENWEATHER}/weather?lat=${lat}&lon=${lng}&appid=${apiKey}&units=metric`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const weatherInfo = {
                    temperature: data.main?.temp,
                    humidity: data.main?.humidity,
                    pressure: data.main?.pressure,
                    description: data.weather?.[0]?.description,
                    windSpeed: data.wind?.speed,
                    visibility: data.visibility
                };
                
                showResult('weather-result', 'success', 'Weather API test successful!', weatherInfo);
            } catch (error) {
                showResult('weather-result', 'error', `Weather API test failed: ${error.message}`);
            }
        }
        
        async function testElevation() {
            const { lat, lng } = getCoords();
            showResult('elevation-result', 'loading', 'Testing elevation API...');
            
            try {
                const response = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                showResult('elevation-result', 'success', 'Elevation API test successful!', data.results[0]);
            } catch (error) {
                showResult('elevation-result', 'error', `Elevation API test failed: ${error.message}`);
            }
        }
        
        async function testNASAPower() {
            const { lat, lng } = getCoords();
            showResult('nasa-result', 'loading', 'Testing NASA POWER API...');
            
            try {
                // Use a date from a few days ago to ensure data availability
                const testDate = new Date();
                testDate.setDate(testDate.getDate() - 7); // 7 days ago
                const dateStr = testDate.toISOString().split('T')[0].replace(/-/g, '');
                
                const url = `https://power.larc.nasa.gov/api/temporal/daily/point?parameters=T2M,RH2M,ALLSKY_SFC_SW_DWN&community=RE&longitude=${lng}&latitude=${lat}&start=${dateStr}&end=${dateStr}&format=JSON`;
                
                console.log('NASA POWER URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('NASA POWER raw response:', data);
                
                // Check for valid data (NASA returns -999 for missing data)
                const temp = data.properties?.parameter?.T2M?.[dateStr];
                const humidity = data.properties?.parameter?.RH2M?.[dateStr];
                const solar = data.properties?.parameter?.ALLSKY_SFC_SW_DWN?.[dateStr];
                
                const processedData = {
                    temperature: (temp && temp !== -999) ? temp : 'No data',
                    humidity: (humidity && humidity !== -999) ? humidity : 'No data',
                    solarRadiation: (solar && solar !== -999) ? solar : 'No data',
                    location: `${lat}, ${lng}`,
                    date: dateStr,
                    note: 'NASA POWER provides global climate data with some gaps'
                };
                
                showResult('nasa-result', 'success', 'NASA POWER API test successful!', processedData);
            } catch (error) {
                showResult('nasa-result', 'error', `NASA POWER API test failed: ${error.message}`);
            }
        }
        

        
        async function testRealAQI() {
            const { lat, lng } = getCoords();
            showResult('realaqi-result', 'loading', 'Testing OpenWeatherMap Air Pollution API...');
            
            try {
                const apiKey = API_CONFIG.OPENWEATHER_API_KEY;
                if (!apiKey) {
                    throw new Error('OpenWeatherMap API key not configured in config.js');
                }
                
                const response = await fetch(`${API_CONFIG.ENDPOINTS.OPENWEATHER}/air_pollution?lat=${lat}&lon=${lng}&appid=${apiKey}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.list || data.list.length === 0) {
                    throw new Error('No air pollution data available');
                }
                
                const pollution = data.list[0];
                const aqi = pollution.main?.aqi;
                const components = pollution.components;
                
                // Convert PM2.5 to US AQI for more accurate representation
                const pm25 = components?.pm2_5 || 0;
                let usAqi;
                let aqiCategory;
                
                if (pm25 <= 12) {
                    usAqi = Math.round((50 / 12) * pm25);
                    aqiCategory = 'Good';
                } else if (pm25 <= 35.4) {
                    usAqi = Math.round(50 + ((100 - 50) / (35.4 - 12)) * (pm25 - 12));
                    aqiCategory = 'Moderate';
                } else if (pm25 <= 55.4) {
                    usAqi = Math.round(100 + ((150 - 100) / (55.4 - 35.4)) * (pm25 - 35.4));
                    aqiCategory = 'Unhealthy for Sensitive';
                } else if (pm25 <= 150.4) {
                    usAqi = Math.round(150 + ((200 - 150) / (150.4 - 55.4)) * (pm25 - 55.4));
                    aqiCategory = 'Unhealthy';
                } else if (pm25 <= 250.4) {
                    usAqi = Math.round(200 + ((300 - 200) / (250.4 - 150.4)) * (pm25 - 150.4));
                    aqiCategory = 'Very Unhealthy';
                } else {
                    usAqi = Math.round(300 + ((500 - 300) / (500.4 - 250.4)) * (pm25 - 250.4));
                    aqiCategory = 'Hazardous';
                }
                
                const aqiDescriptions = {
                    1: 'Good',
                    2: 'Fair', 
                    3: 'Moderate',
                    4: 'Poor',
                    5: 'Very Poor'
                };
                
                const aqiData = {
                    source: 'OpenWeatherMap Air Pollution API',
                    rawAqi: aqi,
                    rawAqiDescription: aqiDescriptions[aqi],
                    pm25BasedUsAqi: usAqi,
                    pm25BasedCategory: aqiCategory,
                    components: {
                        'CO (Carbon Monoxide)': components?.co + ' Œºg/m¬≥',
                        'NO2 (Nitrogen Dioxide)': components?.no2 + ' Œºg/m¬≥',
                        'O3 (Ozone)': components?.o3 + ' Œºg/m¬≥',
                        'SO2 (Sulphur Dioxide)': components?.so2 + ' Œºg/m¬≥',
                        'PM2.5': components?.pm2_5 + ' Œºg/m¬≥',
                        'PM10': components?.pm10 + ' Œºg/m¬≥',
                        'NH3 (Ammonia)': components?.nh3 + ' Œºg/m¬≥'
                    },
                    timestamp: new Date(pollution.dt * 1000).toLocaleString()
                };
                
                showResult('realaqi-result', 'success', 'OpenWeatherMap Air Pollution API test successful!', aqiData);
            } catch (error) {
                showResult('realaqi-result', 'error', `OpenWeatherMap Air Pollution API test failed: ${error.message}`);
            }
        }
        
        async function testAirPollutionHistory() {
            const { lat, lng } = getCoords();
            showResult('airhistory-result', 'loading', 'Testing Air Pollution History API...');
            
            try {
                const apiKey = API_CONFIG.OPENWEATHER_API_KEY;
                if (!apiKey) {
                    throw new Error('OpenWeatherMap API key not configured in config.js');
                }
                
                // Get data from 7 days ago to yesterday
                const end = Math.floor(Date.now() / 1000); // Current timestamp
                const start = end - (7 * 24 * 60 * 60); // 7 days ago
                
                const response = await fetch(`${API_CONFIG.ENDPOINTS.OPENWEATHER}/air_pollution/history?lat=${lat}&lon=${lng}&start=${start}&end=${end}&appid=${apiKey}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.list || data.list.length === 0) {
                    throw new Error('No historical air pollution data available');
                }
                
                // Process last 7 days of data
                const dailyData = data.list.slice(-7).map(item => ({
                    date: new Date(item.dt * 1000).toLocaleDateString(),
                    aqi: item.main.aqi,
                    pm2_5: item.components.pm2_5,
                    pm10: item.components.pm10
                }));
                
                const historyData = {
                    source: 'OpenWeatherMap Air Pollution History API',
                    totalDataPoints: data.list.length,
                    last7Days: dailyData,
                    averageAqi: (dailyData.reduce((sum, day) => sum + day.aqi, 0) / dailyData.length).toFixed(1),
                    averagePM25: (dailyData.reduce((sum, day) => sum + day.pm2_5, 0) / dailyData.length).toFixed(1)
                };
                
                showResult('airhistory-result', 'success', 'Air Pollution History API test successful!', historyData);
            } catch (error) {
                showResult('airhistory-result', 'error', `Air Pollution History API test failed: ${error.message}`);
            }
        }
    </script>
</body>
</html>