<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoped - Sustainability Click POC</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; }
        #container { display: flex; height: 100vh; }
        #map { flex: 1; position: relative; }
        #sidebar { width: 320px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; overflow-y: auto; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
        
        /* Buttons */
        .btn { padding: 12px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; margin: 5px 0; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; transform: translateY(-2px); }
        .btn-secondary { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-secondary:hover { background: rgba(255,255,255,0.3); }
        .popup-btn { background: #f5f5f5; color: #333; border: 1px solid #ddd; }
        .popup-btn:hover { background: #e0e0e0; }
        
        /* Map Controls */
        .map-controls { position: absolute; top: 10px; left: 10px; z-index: 1000; }
        .control-group { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 10px; overflow: hidden; }
        .control-btn { padding: 10px 12px; border: none; background: white; cursor: pointer; border-bottom: 1px solid #eee; width: 100%; text-align: left; }
        .control-btn:hover { background: #f5f5f5; }
        .control-btn:last-child { border-bottom: none; }
        .control-btn.active { background: #007cbf; color: white; }
        
        /* Popups */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; }
        .popup-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .popup-close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #999; }
        
        /* Sidebar styling */
        .score { font-size: 28px; font-weight: bold; margin: 15px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .loading { color: #e0e0e0; font-style: italic; }
        .error { color: #ffcdd2; background: rgba(244,67,54,0.2); padding: 10px; border-radius: 6px; }
        .metric-card { background: rgba(255,255,255,0.1); padding: 15px; margin: 10px 0; border-radius: 8px; backdrop-filter: blur(10px); }
        .metric-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        
        /* Previous clicks */
        .click-item { background: rgba(255,255,255,0.1); padding: 8px 12px; margin: 5px 0; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .click-item:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        <!-- Map Controls -->
        <div class="map-controls">
            <div class="control-group">
                <button class="control-btn" id="help-btn">‚ùì How to Use</button>
                <button class="control-btn" id="basemap-btn">üó∫Ô∏è Basemap</button>
                <button class="control-btn" id="toggle-clicks">üëÅÔ∏è Show Previous Clicks</button>
            </div>
        </div>
        
        <div id="sidebar">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 24px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üåç Scoped</h2>
                <p style="margin: 5px 0; opacity: 0.9;">Sustainability Analysis</p>
            </div>
            
            <button class="btn btn-primary" id="location-btn" style="width: 100%;">üìç Go to My Location</button>
            
            <div id="results">
                <div style="text-align: center; padding: 20px; opacity: 0.8;">
                    <p><em>Click anywhere on the map to analyze sustainability metrics</em></p>
                </div>
            </div>
            
            <div id="previous-clicks" style="display: none;">
                <div class="metric-card">
                    <div class="metric-title">üìç Previous Analyses</div>
                    <div id="clicks-list"></div>
                </div>
            </div>
        </div>
        
        <!-- Help Popup -->
        <div id="help-popup" class="popup-overlay">
            <div class="popup-content">
                <span class="popup-close" onclick="closePopup('help-popup')">&times;</span>
                <h3>üåç How to Use Scoped</h3>
                <p><strong>Getting Started:</strong></p>
                <ul>
                    <li>Click anywhere on the map to analyze that location</li>
                    <li>Use "Go to My Location" to analyze your current area</li>
                    <li>Toggle "Show Previous Clicks" to see all analyzed locations</li>
                </ul>
                
                <p><strong>Sustainability Score Calculation (0-100):</strong></p>
                <p><em>Comprehensive scoring across 6 categories:</em></p>
                <ul>
                    <li><strong>Green Spaces (25%):</strong> 15+ parks/forests within 1km</li>
                    <li><strong>Air Quality (25%):</strong> AQI scale from excellent (25) to hazardous (200+)</li>
                    <li><strong>Healthcare (15%):</strong> 10+ hospitals/clinics within 2km</li>
                    <li><strong>Education (10%):</strong> 8+ schools/colleges within 2km</li>
                    <li><strong>Transport (15%):</strong> 15+ bus stops/stations within 1.5km</li>
                    <li><strong>Services (10%):</strong> 20+ banks/markets/police within 1.5km</li>
                </ul>
                <p><strong>Perfect Score (100):</strong> Optimal levels in all 6 categories</p>
                
                <p><strong>Data Sources:</strong></p>
                <ul>
                    <li>Green spaces: OpenStreetMap via Overpass API</li>
                    <li>Air quality: Estimated based on location</li>
                    <li>Elevation: Open-Elevation API</li>
                </ul>
            </div>
        </div>
        
        <!-- Basemap Popup -->
        <div id="basemap-popup" class="popup-overlay">
            <div class="popup-content">
                <span class="popup-close" onclick="closePopup('basemap-popup')">&times;</span>
                <h3>üó∫Ô∏è Select Basemap</h3>
                <button class="btn popup-btn" onclick="changeBasemap('osm')" style="width: 100%; margin: 5px 0;">OpenStreetMap</button>
                <button class="btn popup-btn" onclick="changeBasemap('satellite')" style="width: 100%; margin: 5px 0;">Google Satellite</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize map with India default center
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors'
                    }
                },
                layers: [{
                    id: 'osm',
                    type: 'raster',
                    source: 'osm'
                }]
            },
            center: [77.2, 28.6], // Delhi, India
            zoom: 10
        });

        // Go to user location
        document.getElementById('location-btn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    map.flyTo({
                        center: [position.coords.longitude, position.coords.latitude],
                        zoom: 12
                    });
                });
            }
        });

        // Previous clicks storage
        let previousClicks = JSON.parse(localStorage.getItem('scopedClicks') || '[]');
        let showingPreviousClicks = false;
        
        // Handle map clicks
        map.on('click', async (e) => {
            const { lng, lat } = e.lngLat;
            
            // Show loading state
            document.getElementById('results').innerHTML = '<div class="loading">üîÑ Analyzing location...</div>';
            
            try {
                // Fetch all data in parallel
                const [greenData, airData, elevationData, healthcareData, educationData, transportData, servicesData] = await Promise.all([
                    fetchGreenSpaces(lat, lng),
                    fetchAirQuality(lat, lng),
                    fetchElevation(lat, lng),
                    fetchHealthcare(lat, lng),
                    fetchEducation(lat, lng),
                    fetchTransport(lat, lng),
                    fetchServices(lat, lng)
                ]);

                // Calculate sustainability score (0-100)
                const score = calculateSustainabilityScore(greenData, airData, elevationData, healthcareData, educationData, transportData, servicesData);
                
                // Save to previous clicks
                const clickData = {
                    lat: lat.toFixed(4),
                    lng: lng.toFixed(4),
                    score,
                    timestamp: new Date().toLocaleString(),
                    greenCount: greenData.count,
                    aqi: airData?.value,
                    elevation: elevationData?.elevation,
                    healthcare: healthcareData?.total || 0,
                    education: educationData?.total || 0,
                    transport: transportData?.total || 0,
                    services: servicesData?.total || 0
                };
                previousClicks.unshift(clickData);
                if (previousClicks.length > 50) previousClicks = previousClicks.slice(0, 50);
                localStorage.setItem('scopedClicks', JSON.stringify(previousClicks));
                
                // Display results
                displayResults(score, greenData, airData, elevationData, healthcareData, educationData, transportData, servicesData, lat, lng);
                updatePreviousClicksList();
                
                // Add popup on map
                new maplibregl.Popup()
                    .setLngLat([lng, lat])
                    .setHTML(`<strong>Sustainability Score: ${score}/100</strong>`)
                    .addTo(map);
                    
            } catch (error) {
                document.getElementById('results').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        });

        // Fetch green spaces using Overpass API
        async function fetchGreenSpaces(lat, lng) {
            console.log('üå≥ Fetching green spaces for:', lat, lng);
            
            const radius = 1000; // 1km radius
            const query = `
                [out:json][timeout:25];
                (
                  way["landuse"="forest"](around:${radius},${lat},${lng});
                  way["leisure"="park"](around:${radius},${lat},${lng});
                  way["natural"="wood"](around:${radius},${lat},${lng});
                  way["landuse"="grass"](around:${radius},${lat},${lng});
                );
                out geom;
            `;
            
            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query
            });
            
            console.log('üìä Overpass response status:', response.status);
            
            if (!response.ok) throw new Error('Overpass API error');
            
            const data = await response.json();
            console.log('‚úÖ Green spaces found:', data.elements.length);
            
            return {
                count: data.elements.length,
                types: [...new Set(data.elements.map(el => el.tags?.landuse || el.tags?.leisure || el.tags?.natural))]
            };
        }
        
        // Fetch healthcare facilities using Overpass API
        async function fetchHealthcare(lat, lng) {
            console.log('üè• Fetching healthcare facilities for:', lat, lng);
            
            const radius = 2000; // 2km radius
            const query = `
                [out:json][timeout:25];
                (
                  node["amenity"="hospital"](around:${radius},${lat},${lng});
                  node["amenity"="clinic"](around:${radius},${lat},${lng});
                  node["amenity"="pharmacy"](around:${radius},${lat},${lng});
                  node["amenity"="doctors"](around:${radius},${lat},${lng});
                );
                out;
            `;
            
            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query
            });
            
            console.log('üìä Healthcare response status:', response.status);
            
            if (!response.ok) throw new Error('Healthcare API error');
            
            const data = await response.json();
            console.log('‚úÖ Healthcare facilities found:', data.elements.length);
            
            const facilities = {
                hospitals: data.elements.filter(el => el.tags?.amenity === 'hospital').length,
                clinics: data.elements.filter(el => el.tags?.amenity === 'clinic').length,
                pharmacies: data.elements.filter(el => el.tags?.amenity === 'pharmacy').length,
                total: data.elements.length
            };
            
            console.log('üéØ Healthcare breakdown:', facilities);
            return facilities;
        }
        
        // Fetch education facilities using Overpass API
        async function fetchEducation(lat, lng) {
            console.log('üè´ Fetching education facilities for:', lat, lng);
            
            const radius = 2000; // 2km radius
            const query = `
                [out:json][timeout:25];
                (
                  node["amenity"="school"](around:${radius},${lat},${lng});
                  node["amenity"="college"](around:${radius},${lat},${lng});
                  node["amenity"="university"](around:${radius},${lat},${lng});
                  node["amenity"="library"](around:${radius},${lat},${lng});
                );
                out;
            `;
            
            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query
            });
            
            console.log('üìä Education response status:', response.status);
            
            if (!response.ok) throw new Error('Education API error');
            
            const data = await response.json();
            console.log('‚úÖ Education facilities found:', data.elements.length);
            
            const facilities = {
                schools: data.elements.filter(el => el.tags?.amenity === 'school').length,
                colleges: data.elements.filter(el => el.tags?.amenity === 'college').length,
                universities: data.elements.filter(el => el.tags?.amenity === 'university').length,
                libraries: data.elements.filter(el => el.tags?.amenity === 'library').length,
                total: data.elements.length
            };
            
            console.log('üéØ Education breakdown:', facilities);
            return facilities;
        }
        
        // Fetch public transport using Overpass API
        async function fetchTransport(lat, lng) {
            console.log('üöå Fetching transport facilities for:', lat, lng);
            
            const radius = 1500; // 1.5km radius
            const query = `
                [out:json][timeout:25];
                (
                  node["public_transport"="stop_position"](around:${radius},${lat},${lng});
                  node["highway"="bus_stop"](around:${radius},${lat},${lng});
                  node["railway"="station"](around:${radius},${lat},${lng});
                  node["public_transport"="station"](around:${radius},${lat},${lng});
                );
                out;
            `;
            
            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query
            });
            
            console.log('üìä Transport response status:', response.status);
            
            if (!response.ok) throw new Error('Transport API error');
            
            const data = await response.json();
            console.log('‚úÖ Transport facilities found:', data.elements.length);
            
            const facilities = {
                busStops: data.elements.filter(el => el.tags?.highway === 'bus_stop' || el.tags?.public_transport === 'stop_position').length,
                stations: data.elements.filter(el => el.tags?.railway === 'station' || el.tags?.public_transport === 'station').length,
                total: data.elements.length
            };
            
            console.log('üéØ Transport breakdown:', facilities);
            return facilities;
        }
        
        // Fetch essential services using Overpass API
        async function fetchServices(lat, lng) {
            console.log('üè¶ Fetching essential services for:', lat, lng);
            
            const radius = 1500; // 1.5km radius
            const query = `
                [out:json][timeout:25];
                (
                  node["amenity"="bank"](around:${radius},${lat},${lng});
                  node["amenity"="atm"](around:${radius},${lat},${lng});
                  node["shop"="supermarket"](around:${radius},${lat},${lng});
                  node["amenity"="marketplace"](around:${radius},${lat},${lng});
                  node["amenity"="post_office"](around:${radius},${lat},${lng});
                  node["amenity"="police"](around:${radius},${lat},${lng});
                );
                out;
            `;
            
            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query
            });
            
            console.log('üìä Services response status:', response.status);
            
            if (!response.ok) throw new Error('Services API error');
            
            const data = await response.json();
            console.log('‚úÖ Essential services found:', data.elements.length);
            
            const facilities = {
                banks: data.elements.filter(el => el.tags?.amenity === 'bank').length,
                atms: data.elements.filter(el => el.tags?.amenity === 'atm').length,
                markets: data.elements.filter(el => el.tags?.shop === 'supermarket' || el.tags?.amenity === 'marketplace').length,
                postOffices: data.elements.filter(el => el.tags?.amenity === 'post_office').length,
                police: data.elements.filter(el => el.tags?.amenity === 'police').length,
                total: data.elements.length
            };
            
            console.log('üéØ Services breakdown:', facilities);
            return facilities;
        }

        // Mock air quality based on location (since free APIs have limitations)
        async function fetchAQI(lat, lon) {
          console.log('üå¨Ô∏è Generating air quality data for:', lat, lon);
          
          // Simple location-based PM2.5 estimation
          // Urban areas (near cities) = higher pollution
          // Rural/elevated areas = lower pollution
          
          const cityDistances = {
            delhi: Math.sqrt((lat - 28.6)** 2 + (lon - 77.2)** 2),
            mumbai: Math.sqrt((lat - 19.1)** 2 + (lon - 72.9)** 2),
            bangalore: Math.sqrt((lat - 12.97)** 2 + (lon - 77.59)** 2)
          };
          
          const nearestCityDistance = Math.min(...Object.values(cityDistances));
          
          // Base AQI: higher near cities, lower in rural areas
          let baseAQI = Math.max(10, 120 - (nearestCityDistance * 200));
          
          // Add some randomness for realism
          const randomFactor = 0.8 + (Math.random() * 0.4); // 0.8 to 1.2
          const aqi = Math.round(baseAQI * randomFactor);
          
          console.log('üéØ Estimated AQI value:', aqi);
          
          return { value: aqi };
        }

        // Compatibility wrapper
        async function fetchAirQuality(lat, lon) {
          return fetchAQI(lat, lon);
        }


        // Fetch elevation using Open-Elevation API
        async function fetchElevation(lat, lng) {
            console.log('‚õ∞Ô∏è Fetching elevation for:', lat, lng);
            
            const response = await fetch(
                `https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`
            );
            
            console.log('üìä Elevation response status:', response.status);
            
            if (!response.ok) throw new Error('Open-Elevation API error');
            
            const data = await response.json();
            console.log('‚úÖ Elevation data:', data.results[0]);
            
            return data.results[0];
        }

        // Calculate sustainability score using percentile-based system (0-100)
        function calculateSustainabilityScore(greenData, airData, elevationData, healthcareData, educationData, transportData, servicesData) {
            // Baseline values for 100th percentile (perfect score)
            const PERFECT_GREEN_SPACES = 15;  // 15+ green features within 1km
            const PERFECT_AQI = 25;           // AQI of 25 (excellent)
            const OPTIMAL_ELEVATION = 800;    // 800m elevation (good air quality, not too high)
            const PERFECT_HEALTHCARE = 10;    // 10+ healthcare facilities within 2km
            const PERFECT_EDUCATION = 8;      // 8+ education facilities within 2km
            const PERFECT_TRANSPORT = 15;     // 15+ transport stops within 1.5km
            const PERFECT_SERVICES = 20;      // 20+ essential services within 1.5km
            
            let totalScore = 0;
            
            // Green spaces score (25% weight)
            const greenPercentile = Math.min(greenData.count / PERFECT_GREEN_SPACES, 1);
            const greenScore = greenPercentile * 25;
            totalScore += greenScore;
            
            // Air quality score (25% weight)
            const aqi = airData?.value;
            let airScore = 0;
            if (aqi !== null && aqi !== undefined) {
                if (aqi <= PERFECT_AQI) airScore = 25;
                else if (aqi <= 50) airScore = 22;
                else if (aqi <= 100) airScore = 18;
                else if (aqi <= 150) airScore = 12;
                else if (aqi <= 200) airScore = 6;
                else airScore = 0;
            }
            totalScore += airScore;
            
            // Healthcare access score (15% weight)
            const healthcarePercentile = Math.min(healthcareData.total / PERFECT_HEALTHCARE, 1);
            const healthcareScore = healthcarePercentile * 15;
            totalScore += healthcareScore;
            
            // Education access score (10% weight)
            const educationPercentile = Math.min(educationData.total / PERFECT_EDUCATION, 1);
            const educationScore = educationPercentile * 10;
            totalScore += educationScore;
            
            // Transport access score (15% weight)
            const transportPercentile = Math.min(transportData.total / PERFECT_TRANSPORT, 1);
            const transportScore = transportPercentile * 15;
            totalScore += transportScore;
            
            // Essential services score (10% weight) - optimal around 800m
            const servicesPercentile = Math.min(servicesData.total / PERFECT_SERVICES, 1);
            const servicesScore = servicesPercentile * 10;
            totalScore += servicesScore;
            
            return Math.round(totalScore);
        }

        // UI Event Handlers
        document.getElementById('help-btn').addEventListener('click', () => {
            document.getElementById('help-popup').style.display = 'block';
        });
        
        document.getElementById('basemap-btn').addEventListener('click', () => {
            document.getElementById('basemap-popup').style.display = 'block';
        });
        
        document.getElementById('toggle-clicks').addEventListener('click', () => {
            showingPreviousClicks = !showingPreviousClicks;
            const clicksDiv = document.getElementById('previous-clicks');
            const btn = document.getElementById('toggle-clicks');
            
            if (showingPreviousClicks) {
                clicksDiv.style.display = 'block';
                btn.classList.add('active');
                btn.textContent = 'üëÅÔ∏è Hide Previous Clicks';
                updatePreviousClicksList();
            } else {
                clicksDiv.style.display = 'none';
                btn.classList.remove('active');
                btn.textContent = 'üëÅÔ∏è Show Previous Clicks';
            }
        });
        
        function closePopup(popupId) {
            document.getElementById(popupId).style.display = 'none';
        }
        
        function changeBasemap(type) {
            if (type === 'satellite') {
                map.setStyle({
                    version: 8,
                    sources: {
                        'satellite': {
                            type: 'raster',
                            tiles: ['https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'],
                            tileSize: 256
                        }
                    },
                    layers: [{ id: 'satellite', type: 'raster', source: 'satellite' }]
                });
            } else {
                map.setStyle({
                    version: 8,
                    sources: {
                        'osm': {
                            type: 'raster',
                            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: '¬© OpenStreetMap contributors'
                        }
                    },
                    layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
                });
            }
            closePopup('basemap-popup');
        }
        
        function updatePreviousClicksList() {
            const listDiv = document.getElementById('clicks-list');
            if (previousClicks.length === 0) {
                listDiv.innerHTML = '<p style="opacity: 0.7;">No previous analyses yet</p>';
                return;
            }
            
            listDiv.innerHTML = previousClicks.slice(0, 10).map(click => 
                `<div class="click-item" onclick="flyToLocation(${click.lat}, ${click.lng})">
                    <strong>Score: ${click.score}/100</strong><br>
                    <small>${click.lat}, ${click.lng} ‚Ä¢ ${click.timestamp}</small>
                </div>`
            ).join('');
        }
        
        function flyToLocation(lat, lng) {
            map.flyTo({ center: [lng, lat], zoom: 12 });
        }
        
        // Display results in sidebar
        function displayResults(score, greenData, airData, elevationData, healthcareData, educationData, transportData, servicesData, lat, lng) {
            const aqi = airData?.value;
            const elevation = elevationData?.elevation;
            
            document.getElementById('results').innerHTML = `
                <div class="score" style="color: ${score > 70 ? '#4CAF50' : score > 40 ? '#FF9800' : '#F44336'}">
                    ${score}/100
                </div>
                <p style="text-align: center; opacity: 0.9; margin-bottom: 20px;"><strong>üìç ${lat.toFixed(4)}, ${lng.toFixed(4)}</strong></p>
                
                <div class="metric-card">
                    <div class="metric-title">üå≥ Green Spaces</div>
                    <p><strong>${greenData.count}</strong> features within 1km</p>
                    <p style="font-size: 12px; opacity: 0.8;">Types: ${greenData.types.join(', ') || 'None detected'}</p>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">üè• Healthcare</div>
                    <p><strong>${healthcareData.total}</strong> facilities within 2km</p>
                    <p style="font-size: 12px; opacity: 0.8;">${healthcareData.hospitals} hospitals, ${healthcareData.clinics} clinics, ${healthcareData.pharmacies} pharmacies</p>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">üè´ Education</div>
                    <p><strong>${educationData.total}</strong> facilities within 2km</p>
                    <p style="font-size: 12px; opacity: 0.8;">${educationData.schools} schools, ${educationData.colleges} colleges, ${educationData.libraries} libraries</p>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">üöå Transport</div>
                    <p><strong>${transportData.total}</strong> stops within 1.5km</p>
                    <p style="font-size: 12px; opacity: 0.8;">${transportData.busStops} bus stops, ${transportData.stations} stations</p>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">üè¶ Services</div>
                    <p><strong>${servicesData.total}</strong> facilities within 1.5km</p>
                    <p style="font-size: 12px; opacity: 0.8;">${servicesData.banks} banks, ${servicesData.markets} markets, ${servicesData.police} police</p>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">üå¨Ô∏è Air Quality</div>
                    <p><strong>AQI:</strong> ${aqi || 'No data'}</p>
                    ${aqi ? `<p style="color: ${aqi <= 50 ? '#4CAF50' : aqi <= 100 ? '#FF9800' : aqi <= 150 ? '#FF5722' : aqi <= 200 ? '#F44336' : aqi <= 300 ? '#9C27B0' : '#8D6E63'}; font-weight: 500; font-size: 12px;">${aqi <= 50 ? 'Good' : aqi <= 100 ? 'Moderate' : aqi <= 150 ? 'Unhealthy for Sensitive' : aqi <= 200 ? 'Unhealthy' : aqi <= 300 ? 'Very Unhealthy' : 'Hazardous'}</p>` : ''}
                </div>
            `;
        }
        // Initialize previous clicks on load
        updatePreviousClicksList();
        
        // Close popups when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('popup-overlay')) {
                e.target.style.display = 'none';
            }
        });
    </script>
</body>
</html>