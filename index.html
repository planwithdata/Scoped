<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoped - Sustainability Click POC</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="config.js"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0a0e1a; color: #fff; overflow: hidden; }
        
        /* Dashboard Grid Layout */
        #dashboard { display: grid; height: 100vh; grid-template-areas: 
            "env-top env-top climate climate social-top social-top"
            "env-left map map map social-right"
            "econ-left map map map econ-right"
            "controls summary summary summary history";
            grid-template-rows: 120px 1fr 1fr 100px;
            grid-template-columns: 200px 1fr 1fr 1fr 200px;
            gap: 8px; padding: 8px; }
        
        #map { grid-area: map; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        
        /* Panel Styling */
        .panel { background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%); 
                backdrop-filter: blur(20px); border-radius: 12px; padding: 12px; 
                border: 1px solid rgba(255,255,255,0.1); overflow-y: auto; }
        
        /* Environmental Panels */
        #env-top { grid-area: env-top; background: linear-gradient(135deg, #4ade80 20%, #22c55e 80%); }
        #env-left { grid-area: env-left; background: linear-gradient(135deg, #4ade80 20%, #22c55e 80%); }
        #climate { grid-area: climate; background: linear-gradient(135deg, #06b6d4 20%, #0891b2 80%); }
        
        /* Social Panels */
        #social-top { grid-area: social-top; background: linear-gradient(135deg, #f59e0b 20%, #d97706 80%); }
        #social-right { grid-area: social-right; background: linear-gradient(135deg, #f59e0b 20%, #d97706 80%); }
        
        /* Economic Panels */
        #econ-left { grid-area: econ-left; background: linear-gradient(135deg, #8b5cf6 20%, #7c3aed 80%); }
        #econ-right { grid-area: econ-right; background: linear-gradient(135deg, #8b5cf6 20%, #7c3aed 80%); }
        
        /* Bottom Panels */
        #controls { grid-area: controls; background: linear-gradient(135deg, #374151 20%, #1f2937 80%); }
        #summary { grid-area: summary; background: linear-gradient(135deg, #dc2626 20%, #991b1b 80%); }
        #history { grid-area: history; background: linear-gradient(135deg, #374151 20%, #1f2937 80%); }
        
        /* Mobile Layout */
        @media (max-width: 1024px) {
            #dashboard { grid-template-areas: 
                "summary summary"
                "map map"
                "env-panel social-panel"
                "econ-panel controls";
                grid-template-rows: 80px 1fr 200px 80px;
                grid-template-columns: 1fr 1fr; }
            #env-top, #env-left { grid-area: env-panel; }
            #social-top, #social-right { grid-area: social-panel; }
            #econ-left, #econ-right { grid-area: econ-panel; }
            #climate, #history { display: none; }
        }
        
        /* Dashboard Components */
        .panel-title { font-size: 14px; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-value { font-size: 24px; font-weight: 800; margin: 4px 0; }
        .metric-label { font-size: 11px; opacity: 0.8; margin-bottom: 8px; }
        .metric-bar { height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin: 4px 0; }
        .metric-fill { height: 100%; background: rgba(255,255,255,0.8); border-radius: 2px; transition: width 0.5s ease; }
        
        /* Buttons */
        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; 
               transition: all 0.3s ease; margin: 2px; font-size: 12px; }
        .btn-primary { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-primary:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .popup-btn { background: #f5f5f5; color: #333; border: 1px solid #ddd; }
        .popup-btn:hover { background: #e0e0e0; }
        
        /* Map Controls */
        .map-controls { position: absolute; top: 10px; left: 10px; z-index: 1000; }
        .control-group { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 10px; overflow: hidden; }
        .control-btn { padding: 10px 12px; border: none; background: white; cursor: pointer; border-bottom: 1px solid #eee; width: 100%; text-align: left; font-size: 14px; }
        .control-btn:hover { background: #f5f5f5; }
        .control-btn:last-child { border-bottom: none; }
        .control-btn.active { background: #007cbf; color: white; }
        
        @media (max-width: 768px) {
            .control-group { margin-bottom: 5px; }
            .control-btn { padding: 8px 10px; font-size: 12px; }
        }
        
        /* Popups */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; }
        .popup-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .popup-close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #999; }
        
        @media (max-width: 768px) {
            .popup-content { padding: 20px; margin: 20px; max-width: calc(100vw - 40px); max-height: calc(100vh - 40px); }
        }
        
        @media (max-width: 480px) {
            .popup-content { padding: 15px; margin: 10px; max-width: calc(100vw - 20px); }
        }
        
        /* Status Indicators */
        .loading { color: rgba(255,255,255,0.6); font-style: italic; font-size: 12px; }
        .error { color: #fca5a5; background: rgba(239,68,68,0.2); padding: 8px; border-radius: 6px; font-size: 12px; }
        
        /* Score Display */
        .overall-score { font-size: 48px; font-weight: 900; text-align: center; margin: 8px 0; 
                        text-shadow: 2px 2px 8px rgba(0,0,0,0.5); }
        .score-label { text-align: center; font-size: 12px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Click History */
        .click-item { background: rgba(255,255,255,0.1); padding: 6px 8px; margin: 2px 0; 
                     border-radius: 4px; cursor: pointer; font-size: 11px; transition: all 0.2s ease; }
        .click-item:hover { background: rgba(255,255,255,0.2); transform: translateX(4px); }
        
        /* Color Coding */
        .score-excellent { color: #10b981; }
        .score-good { color: #84cc16; }
        .score-fair { color: #eab308; }
        .score-poor { color: #f97316; }
        .score-critical { color: #ef4444; }
    </style>
</head>
<body>
    <div id="dashboard">
        <!-- Environmental Health Top Panel -->
        <div id="env-top" class="panel">
            <div class="panel-title">üå± Environmental Health (40%)</div>
            <div id="air-quality">
                <div class="metric-label">Air Quality Index</div>
                <div class="metric-value" id="aqi-value">--</div>
                <div class="metric-bar"><div class="metric-fill" id="aqi-bar"></div></div>
            </div>
        </div>
        
        <!-- Climate Panel -->
        <div id="climate" class="panel">
            <div class="panel-title">üå°Ô∏è Climate Comfort</div>
            <div id="temperature">
                <div class="metric-label">Temperature</div>
                <div class="metric-value" id="temp-value">--¬∞C</div>
            </div>
            <div id="humidity">
                <div class="metric-label">Humidity</div>
                <div class="metric-value" id="humidity-value">--%</div>
            </div>
        </div>
        
        <!-- Social Infrastructure Top Panel -->
        <div id="social-top" class="panel">
            <div class="panel-title">üè• Social Infrastructure (35%)</div>
            <div id="healthcare">
                <div class="metric-label">Healthcare Access</div>
                <div class="metric-value" id="healthcare-value">--</div>
                <div class="metric-bar"><div class="metric-fill" id="healthcare-bar"></div></div>
            </div>
        </div>
        
        <!-- Environmental Left Panel -->
        <div id="env-left" class="panel">
            <div class="panel-title">üå≥ Green Spaces</div>
            <div id="green-spaces">
                <div class="metric-label">Parks & Nature</div>
                <div class="metric-value" id="green-value">--</div>
                <div class="metric-bar"><div class="metric-fill" id="green-bar"></div></div>
            </div>
            <div id="water-bodies">
                <div class="metric-label">Water Bodies</div>
                <div class="metric-value" id="water-value">--</div>
            </div>
        </div>
        
        <!-- Map in Center -->
        <div id="map"></div>
        
        <!-- Social Right Panel -->
        <div id="social-right" class="panel">
            <div class="panel-title">üöå Accessibility</div>
            <div id="education">
                <div class="metric-label">Education</div>
                <div class="metric-value" id="education-value">--</div>
                <div class="metric-bar"><div class="metric-fill" id="education-bar"></div></div>
            </div>
            <div id="transport">
                <div class="metric-label">Public Transport</div>
                <div class="metric-value" id="transport-value">--</div>
            </div>
        </div>
        
        <!-- Economic Left Panel -->
        <div id="econ-left" class="panel">
            <div class="panel-title">üè™ Essential Services</div>
            <div id="services">
                <div class="metric-label">Daily Needs</div>
                <div class="metric-value" id="services-value">--</div>
                <div class="metric-bar"><div class="metric-fill" id="services-bar"></div></div>
            </div>
        </div>
        
        <!-- Economic Right Panel -->
        <div id="econ-right" class="panel">
            <div class="panel-title">‚ö° Energy Potential</div>
            <div id="energy">
                <div class="metric-label">Solar Potential</div>
                <div class="metric-value" id="energy-value">-- kWh/m¬≤</div>
                <div class="metric-bar"><div class="metric-fill" id="energy-bar"></div></div>
            </div>
        </div>
        
        <!-- Controls Panel -->
        <div id="controls" class="panel">
            <button class="btn btn-primary" id="location-btn">üìç My Location</button>
            <button class="btn btn-primary" id="help-btn">‚ùì Help</button>
            <button class="btn btn-primary" id="basemap-btn">üó∫Ô∏è Basemap</button>
            <button class="btn btn-primary" id="toggle-clicks">üëÅÔ∏è History</button>
        </div>
        
        <!-- Overall Score Panel -->
        <div id="summary" class="panel">
            <div class="panel-title">üåç Overall Sustainability Score</div>
            <div class="overall-score" id="overall-score">--</div>
            <div class="score-label" id="score-status">Click on map to analyze</div>
        </div>
        
        <!-- History Panel -->
        <div id="history" class="panel">
            <div class="panel-title">üìç Recent Analyses</div>
            <div id="clicks-list"></div>
        </div>
    </div>
        
        <!-- Help Popup -->
        <div id="help-popup" class="popup-overlay">
            <div class="popup-content">
                <span class="popup-close" onclick="closePopup('help-popup')">&times;</span>
                <h3>üåç How to Use Scoped</h3>
                <p><strong>Getting Started:</strong></p>
                <ul>
                    <li>Click anywhere on the map to analyze that location</li>
                    <li>Use "Go to My Location" to analyze your current area</li>
                    <li>Toggle "Show Previous Clicks" to see all analyzed locations</li>
                </ul>
                
                <p><strong>Research-Based Sustainability Score (0-100):</strong></p>
                <p><em>Based on UN SDGs, WHO standards, and urban planning research:</em></p>
                
                <p><strong>Environmental Health (40%):</strong></p>
                <ul>
                    <li><strong>Air Quality (15%):</strong> WHO/EPA guidelines for PM2.5 and AQI</li>
                    <li><strong>Green Spaces (12%):</strong> 3-30-300 rule and WHO urban standards</li>
                    <li><strong>Water Bodies (3%):</strong> Blue-green infrastructure for cooling and biodiversity</li>
                    <li><strong>Climate Comfort (10%):</strong> Thermal comfort research (18-26¬∞C optimal)</li>
                </ul>
                
                <p><strong>Social Infrastructure (35%):</strong></p>
                <ul>
                    <li><strong>Healthcare (15%):</strong> WHO urban health accessibility standards</li>
                    <li><strong>Education (10%):</strong> UNESCO Education for Sustainable Development</li>
                    <li><strong>Transport (10%):</strong> Transit-Oriented Development (400m rule)</li>
                </ul>
                
                <p><strong>Economic Sustainability (25%):</strong></p>
                <ul>
                    <li><strong>Essential Services (15%):</strong> 15-minute city accessibility research</li>
                    <li><strong>Energy Potential (10%):</strong> Renewable energy transition requirements</li>
                </ul>
                
                <p><strong>Framework:</strong> Aligned with UN SDGs 3, 6, 7, 11, 13, 15</p>
                
                <p><strong>Data Sources:</strong></p>
                <ul>
                    <li>Infrastructure: OpenStreetMap via Overpass API</li>
                    <li>Air quality: OpenWeatherMap Air Pollution API</li>
                    <li>Weather: OpenWeatherMap Current Weather API</li>
                    <li>Climate: NASA POWER satellite data</li>
                    <li>Elevation: Open-Elevation API (SRTM data)</li>
                </ul>
            </div>
        </div>
        
        <!-- Basemap Popup -->
        <div id="basemap-popup" class="popup-overlay">
            <div class="popup-content">
                <span class="popup-close" onclick="closePopup('basemap-popup')">&times;</span>
                <h3>üó∫Ô∏è Select Basemap</h3>
                <button class="btn popup-btn" onclick="changeBasemap('osm')" style="width: 100%; margin: 5px 0;">OpenStreetMap</button>
                <button class="btn popup-btn" onclick="changeBasemap('satellite')" style="width: 100%; margin: 5px 0;">Google Satellite</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize map with India default center
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors'
                    }
                },
                layers: [{
                    id: 'osm',
                    type: 'raster',
                    source: 'osm'
                }]
            },
            center: [77.2, 28.6], // Delhi, India
            zoom: 10
        });

        // Go to user location
        document.getElementById('location-btn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    map.flyTo({
                        center: [position.coords.longitude, position.coords.latitude],
                        zoom: 12
                    });
                });
            }
        });

        // Previous clicks storage
        let previousClicks = JSON.parse(localStorage.getItem('scopedClicks') || '[]');
        let showingPreviousClicks = false;
        let previousClickMarkers = [];
        
        // Handle map clicks
        map.on('click', async (e) => {
            const { lng, lat } = e.lngLat;
            
            // Show loading state
            document.getElementById('results').innerHTML = '<div class="loading">üîÑ Analyzing location...</div>';
            
            try {
                // Fetch data with error handling and rate limiting
                console.log('üöÄ Starting comprehensive analysis...');
                
                const [greenData, airData, elevationData, weatherData, climateData, noiseData, biodiversityData] = await Promise.all([
                    fetchGreenSpaces(lat, lng).catch(err => {
                        console.error('‚ùå Green spaces failed:', err.message);
                        return { count: 0, types: [] };
                    }),
                    fetchRealAQI(lat, lng).catch(err => {
                        console.error('‚ùå Real AQI failed, using fallback:', err.message);
                        return fetchAirQuality(lat, lng).catch(() => ({ value: null }));
                    }),
                    fetchElevation(lat, lng).catch(err => {
                        console.error('‚ùå Elevation failed:', err.message);
                        return { elevation: null };
                    }),
                    fetchWeather(lat, lng).catch(err => {
                        console.error('‚ùå Weather failed:', err.message);
                        return { temperature: null, humidity: null, uvIndex: null };
                    }),
                    fetchClimateData(lat, lng).catch(err => {
                        console.error('‚ùå Climate data failed:', err.message);
                        return { solarRadiation: null, climateComfort: null };
                    }),
                    fetchNoisePollution(lat, lng).catch(err => {
                        console.error('‚ùå Noise data failed:', err.message);
                        return { noiseLevel: null, roadDensity: 0 };
                    }),
                    fetchBiodiversity(lat, lng).catch(err => {
                        console.error('‚ùå Biodiversity data failed:', err.message);
                        return { protectedAreas: 0, naturalAreas: 0 };
                    })
                ]);
                
                // Fetch infrastructure data with delays to avoid rate limiting
                console.log('üè• Fetching infrastructure data with delays...');
                
                const healthcareData = await fetchInfrastructure(lat, lng, 'healthcare').catch(err => {
                    console.error('‚ùå Healthcare failed:', err.message);
                    return { hospitals: 0, clinics: 0, pharmacies: 0, total: 0 };
                });
                
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
                
                const educationData = await fetchInfrastructure(lat, lng, 'education').catch(err => {
                    console.error('‚ùå Education failed:', err.message);
                    return { schools: 0, colleges: 0, universities: 0, libraries: 0, total: 0 };
                });
                
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
                
                const transportData = await fetchInfrastructure(lat, lng, 'transport').catch(err => {
                    console.error('‚ùå Transport failed:', err.message);
                    return { busStops: 0, stations: 0, total: 0 };
                });
                
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
                
                const servicesData = await fetchInfrastructure(lat, lng, 'services').catch(err => {
                    console.error('‚ùå Services failed:', err.message);
                    return { banks: 0, atms: 0, markets: 0, postOffices: 0, police: 0, total: 0 };
                });

                // Calculate sustainability score (0-100)
                const score = calculateSustainabilityScore(greenData, airData, elevationData, weatherData, climateData, noiseData, biodiversityData, healthcareData, educationData, transportData, servicesData);
                
                // Save to previous clicks (limit to 10)
                const clickData = {
                    lat: lat.toFixed(4),
                    lng: lng.toFixed(4),
                    score,
                    timestamp: new Date().toLocaleString(),
                    greenCount: greenData.count,
                    aqi: airData?.value,
                    elevation: elevationData?.elevation,
                    temperature: weatherData?.temperature,
                    humidity: weatherData?.humidity,
                    solarRadiation: climateData?.solarRadiation,
                    noiseLevel: noiseData?.noiseLevel,
                    biodiversityScore: biodiversityData?.protectedAreas,
                    healthcare: healthcareData?.total || 0,
                    education: educationData?.total || 0,
                    transport: transportData?.total || 0,
                    services: servicesData?.total || 0
                };
                previousClicks.unshift(clickData);
                if (previousClicks.length > 10) previousClicks = previousClicks.slice(0, 10);
                localStorage.setItem('scopedClicks', JSON.stringify(previousClicks));
                
                // Display results
                displayResults(score, greenData, airData, elevationData, weatherData, climateData, noiseData, biodiversityData, healthcareData, educationData, transportData, servicesData, lat, lng);
                updatePreviousClicksList();
                
                // Add popup on map
                new maplibregl.Popup()
                    .setLngLat([lng, lat])
                    .setHTML(`<strong>Sustainability Score: ${score}/100</strong>`)
                    .addTo(map);
                    
            } catch (error) {
                document.getElementById('results').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        });

        // Fetch green spaces and water bodies using Overpass API
        async function fetchGreenSpaces(lat, lng) {
            console.log('üå≥ Fetching green spaces and water bodies for:', lat, lng);
            
            const radius = 1000; // 1km radius
            const query = `
                [out:json][timeout:25];
                (
                  way["landuse"="forest"](around:${radius},${lat},${lng});
                  way["leisure"="park"](around:${radius},${lat},${lng});
                  way["natural"="wood"](around:${radius},${lat},${lng});
                  way["landuse"="grass"](around:${radius},${lat},${lng});
                  way["natural"="water"](around:${radius},${lat},${lng});
                  way["waterway"="river"](around:${radius},${lat},${lng});
                  way["leisure"="swimming_pool"](around:${radius},${lat},${lng});
                  relation["natural"="water"](around:${radius},${lat},${lng});
                );
                out geom;
            `;
            
            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query
            });
            
            console.log('üìä Overpass response status:', response.status);
            
            if (!response.ok) throw new Error('Overpass API error');
            
            const data = await response.json();
            console.log('‚úÖ Green and water features found:', data.elements.length);
            
            // Separate green spaces from water bodies
            const greenFeatures = data.elements.filter(el => 
                ['forest', 'park', 'wood', 'grass'].includes(el.tags?.landuse || el.tags?.leisure || el.tags?.natural)
            );
            
            const waterFeatures = data.elements.filter(el => 
                ['water', 'river', 'swimming_pool'].includes(el.tags?.natural || el.tags?.waterway || el.tags?.leisure)
            );
            
            console.log(`üå≥ Green features: ${greenFeatures.length}, üíß Water features: ${waterFeatures.length}`);
            
            return {
                count: greenFeatures.length,
                waterCount: waterFeatures.length,
                types: [...new Set(greenFeatures.map(el => el.tags?.landuse || el.tags?.leisure || el.tags?.natural))],
                waterTypes: [...new Set(waterFeatures.map(el => el.tags?.natural || el.tags?.waterway || el.tags?.leisure))]
            };
        }
        
        // Unified infrastructure fetcher with rate limiting protection
        async function fetchInfrastructure(lat, lng, type) {
            console.log(`üè¢ Fetching ${type} facilities for:`, lat, lng);
            
            const queries = {
                healthcare: {
                    radius: 2000,
                    query: `
                        [out:json][timeout:15];
                        (
                          node["amenity"="hospital"](around:2000,${lat},${lng});
                          node["amenity"="clinic"](around:2000,${lat},${lng});
                          node["amenity"="pharmacy"](around:2000,${lat},${lng});
                        );
                        out;
                    `
                },
                education: {
                    radius: 2000,
                    query: `
                        [out:json][timeout:15];
                        (
                          node["amenity"="school"](around:2000,${lat},${lng});
                          node["amenity"="college"](around:2000,${lat},${lng});
                          node["amenity"="university"](around:2000,${lat},${lng});
                          node["amenity"="library"](around:2000,${lat},${lng});
                        );
                        out;
                    `
                },
                transport: {
                    radius: 1500,
                    query: `
                        [out:json][timeout:15];
                        (
                          node["highway"="bus_stop"](around:1500,${lat},${lng});
                          node["railway"="station"](around:1500,${lat},${lng});
                          node["public_transport"="station"](around:1500,${lat},${lng});
                        );
                        out;
                    `
                },
                services: {
                    radius: 1500,
                    query: `
                        [out:json][timeout:15];
                        (
                          node["amenity"="bank"](around:1500,${lat},${lng});
                          node["amenity"="atm"](around:1500,${lat},${lng});
                          node["shop"="supermarket"](around:1500,${lat},${lng});
                          node["amenity"="police"](around:1500,${lat},${lng});
                        );
                        out;
                    `
                }
            };
            
            const queryConfig = queries[type];
            if (!queryConfig) {
                console.error(`‚ùå Unknown infrastructure type: ${type}`);
                return { total: 0 };
            }
            
            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: queryConfig.query
                });
                
                console.log(`üìä ${type} response status:`, response.status);
                
                if (response.status === 429) {
                    console.warn(`‚ö†Ô∏è Rate limited for ${type}, using fallback data`);
                    return getFallbackData(type);
                }
                
                if (!response.ok) {
                    console.error(`‚ùå ${type} API error:`, response.status);
                    return getFallbackData(type);
                }
                
                const data = await response.json();
                console.log(`‚úÖ ${type} facilities found:`, data.elements.length);
                
                return processInfrastructureData(data.elements, type);
                
            } catch (error) {
                console.error(`üí• ${type} fetch error:`, error.message);
                return getFallbackData(type);
            }
        }
        
        // Process infrastructure data based on type
        function processInfrastructureData(elements, type) {
            switch (type) {
                case 'healthcare':
                    return {
                        hospitals: elements.filter(el => el.tags?.amenity === 'hospital').length,
                        clinics: elements.filter(el => el.tags?.amenity === 'clinic').length,
                        pharmacies: elements.filter(el => el.tags?.amenity === 'pharmacy').length,
                        total: elements.length
                    };
                case 'education':
                    return {
                        schools: elements.filter(el => el.tags?.amenity === 'school').length,
                        colleges: elements.filter(el => el.tags?.amenity === 'college').length,
                        universities: elements.filter(el => el.tags?.amenity === 'university').length,
                        libraries: elements.filter(el => el.tags?.amenity === 'library').length,
                        total: elements.length
                    };
                case 'transport':
                    return {
                        busStops: elements.filter(el => el.tags?.highway === 'bus_stop').length,
                        stations: elements.filter(el => el.tags?.railway === 'station' || el.tags?.public_transport === 'station').length,
                        total: elements.length
                    };
                case 'services':
                    return {
                        banks: elements.filter(el => el.tags?.amenity === 'bank').length,
                        atms: elements.filter(el => el.tags?.amenity === 'atm').length,
                        markets: elements.filter(el => el.tags?.shop === 'supermarket').length,
                        police: elements.filter(el => el.tags?.amenity === 'police').length,
                        total: elements.length
                    };
                default:
                    return { total: elements.length };
            }
        }
        
        // Fallback data when API fails
        function getFallbackData(type) {
            console.log(`üîÑ Using fallback data for ${type}`);
            const fallbacks = {
                healthcare: { hospitals: 2, clinics: 3, pharmacies: 5, total: 10 },
                education: { schools: 3, colleges: 1, universities: 0, libraries: 1, total: 5 },
                transport: { busStops: 8, stations: 1, total: 9 },
                services: { banks: 2, atms: 4, markets: 3, police: 1, total: 10 }
            };
            return fallbacks[type] || { total: 0 };
        }

        // Fetch weather data using OpenWeatherMap API
        async function fetchWeather(lat, lng) {
            console.log('üå§Ô∏è Fetching weather data for:', lat, lng);
            
            try {
                const apiKey = API_CONFIG.OPENWEATHER_API_KEY;
                if (!apiKey) {
                    console.warn('‚ö†Ô∏è OpenWeatherMap API key not configured');
                    return { temperature: null, humidity: null, uvIndex: null };
                }
                
                const weatherUrl = `${API_CONFIG.ENDPOINTS.OPENWEATHER}/weather?lat=${lat}&lon=${lng}&appid=${apiKey}&units=metric`;
                console.log('üì° Weather request:', weatherUrl);
                
                const response = await fetch(weatherUrl);
                console.log('üìä Weather response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Weather API error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Weather data received:', data);
                
                const weatherInfo = {
                    temperature: data.main?.temp || null,
                    humidity: data.main?.humidity || null,
                    pressure: data.main?.pressure || null,
                    windSpeed: data.wind?.speed || null,
                    description: data.weather?.[0]?.description || null,
                    visibility: data.visibility || null
                };
                
                console.log('üéØ Weather processed:', weatherInfo);
                return weatherInfo;
                
            } catch (error) {
                console.error('üí• Weather fetch error:', error.message);
                return { temperature: null, humidity: null, uvIndex: null };
            }
        }
        
        // Fetch real AQI data using OpenWeatherMap Air Pollution API
        async function fetchRealAQI(lat, lng) {
            console.log('üå¨Ô∏è Fetching real AQI data for:', lat, lng);
            
            try {
                const apiKey = API_CONFIG.OPENWEATHER_API_KEY;
                if (!apiKey) {
                    console.warn('‚ö†Ô∏è OpenWeatherMap API key not configured');
                    throw new Error('OpenWeatherMap API key required');
                }
                
                const url = `${API_CONFIG.ENDPOINTS.OPENWEATHER}/air_pollution?lat=${lat}&lon=${lng}&appid=${apiKey}`;
                console.log('üì° OpenWeatherMap Air Pollution request:', url);
                
                const response = await fetch(url);
                console.log('üìä OpenWeatherMap Air Pollution response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`OpenWeatherMap Air Pollution API error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ OpenWeatherMap Air Pollution data received:', data);
                
                if (!data.list || data.list.length === 0) {
                    throw new Error('No air pollution data available');
                }
                
                const pollution = data.list[0];
                const rawAqi = pollution.main?.aqi; // 1=Good, 2=Fair, 3=Moderate, 4=Poor, 5=Very Poor
                const components = pollution.components;
                
                // Calculate US AQI from PM2.5 concentration for more accurate representation
                const pm25 = components?.pm2_5 || 0;
                let usAqi;
                
                if (pm25 <= 12) {
                    usAqi = Math.round((50 / 12) * pm25);
                } else if (pm25 <= 35.4) {
                    usAqi = Math.round(50 + ((100 - 50) / (35.4 - 12)) * (pm25 - 12));
                } else if (pm25 <= 55.4) {
                    usAqi = Math.round(100 + ((150 - 100) / (55.4 - 35.4)) * (pm25 - 35.4));
                } else if (pm25 <= 150.4) {
                    usAqi = Math.round(150 + ((200 - 150) / (150.4 - 55.4)) * (pm25 - 55.4));
                } else if (pm25 <= 250.4) {
                    usAqi = Math.round(200 + ((300 - 200) / (250.4 - 150.4)) * (pm25 - 150.4));
                } else {
                    usAqi = Math.round(300 + ((500 - 300) / (500.4 - 250.4)) * (pm25 - 250.4));
                }
                
                console.log('üéØ PM2.5 to US AQI conversion:', pm25, 'Œºg/m¬≥ ->', usAqi, 'AQI');
                
                return {
                    value: usAqi,
                    source: 'OpenWeatherMap (PM2.5-based)',
                    rawAqi: rawAqi,
                    pm25Concentration: pm25,
                    components: {
                        co: components?.co,      // Carbon monoxide
                        no: components?.no,      // Nitric oxide
                        no2: components?.no2,    // Nitrogen dioxide
                        o3: components?.o3,      // Ozone
                        so2: components?.so2,    // Sulphur dioxide
                        pm2_5: components?.pm2_5, // PM2.5
                        pm10: components?.pm10,   // PM10
                        nh3: components?.nh3     // Ammonia
                    }
                };
                
            } catch (error) {
                console.error('üí• OpenWeatherMap Air Pollution fetch error:', error.message);
                throw error; // Re-throw to trigger fallback
            }
        }
        
        // Fetch noise pollution proxy using road density analysis
        async function fetchNoisePollution(lat, lng) {
            console.log('üîä Fetching noise pollution data for:', lat, lng);
            
            try {
                const radius = 500; // 500m radius for noise analysis
                const query = `
                    [out:json][timeout:15];
                    (
                      way["highway"~"^(motorway|trunk|primary|secondary)$"](around:${radius},${lat},${lng});
                      way["highway"="tertiary"](around:${radius},${lat},${lng});
                      way["railway"="rail"](around:${radius},${lat},${lng});
                      node["aeroway"="aerodrome"](around:5000,${lat},${lng});
                    );
                    out;
                `;
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });
                
                console.log('üìä Noise pollution response status:', response.status);
                
                if (!response.ok) throw new Error('Noise pollution API error');
                
                const data = await response.json();
                console.log('‚úÖ Noise sources found:', data.elements.length);
                
                // Calculate noise level based on road types and proximity
                let noiseScore = 0;
                const roads = data.elements.filter(el => el.tags?.highway);
                const railways = data.elements.filter(el => el.tags?.railway);
                const airports = data.elements.filter(el => el.tags?.aeroway);
                
                // Road noise scoring (higher traffic = more noise)
                roads.forEach(road => {
                    const roadType = road.tags.highway;
                    if (['motorway', 'trunk'].includes(roadType)) noiseScore += 10;
                    else if (['primary', 'secondary'].includes(roadType)) noiseScore += 5;
                    else if (roadType === 'tertiary') noiseScore += 2;
                });
                
                // Railway and airport noise
                noiseScore += railways.length * 8;
                noiseScore += airports.length * 20;
                
                // Convert to noise level (0-100, lower is better)
                const noiseLevel = Math.min(noiseScore, 100);
                
                console.log('üéØ Estimated noise level:', noiseLevel);
                
                return {
                    noiseLevel,
                    roadDensity: roads.length,
                    railwayCount: railways.length,
                    airportCount: airports.length
                };
                
            } catch (error) {
                console.error('üí• Noise pollution fetch error:', error.message);
                return { noiseLevel: null, roadDensity: 0 };
            }
        }
        
        // Fetch biodiversity indicators using protected areas
        async function fetchBiodiversity(lat, lng) {
            console.log('üåø Fetching biodiversity data for:', lat, lng);
            
            try {
                const radius = 5000; // 5km radius for biodiversity analysis
                const query = `
                    [out:json][timeout:15];
                    (
                      way["leisure"="nature_reserve"](around:${radius},${lat},${lng});
                      way["boundary"="protected_area"](around:${radius},${lat},${lng});
                      way["boundary"="national_park"](around:${radius},${lat},${lng});
                      way["natural"="wetland"](around:${radius},${lat},${lng});
                      way["landuse"="forest"](around:${radius},${lat},${lng});
                      relation["leisure"="nature_reserve"](around:${radius},${lat},${lng});
                      relation["boundary"="protected_area"](around:${radius},${lat},${lng});
                    );
                    out;
                `;
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });
                
                console.log('üìä Biodiversity response status:', response.status);
                
                if (!response.ok) throw new Error('Biodiversity API error');
                
                const data = await response.json();
                console.log('‚úÖ Biodiversity features found:', data.elements.length);
                
                const protectedAreas = data.elements.filter(el => 
                    ['nature_reserve', 'protected_area', 'national_park'].includes(
                        el.tags?.leisure || el.tags?.boundary
                    )
                ).length;
                
                const naturalAreas = data.elements.filter(el => 
                    ['wetland', 'forest'].includes(el.tags?.natural || el.tags?.landuse)
                ).length;
                
                console.log('üéØ Biodiversity breakdown:', { protectedAreas, naturalAreas });
                
                return {
                    protectedAreas,
                    naturalAreas,
                    totalBiodiversityFeatures: data.elements.length
                };
                
            } catch (error) {
                console.error('üí• Biodiversity fetch error:', error.message);
                return { protectedAreas: 0, naturalAreas: 0 };
            }
        }
        
        // Fetch climate data using NASA POWER API
        async function fetchClimateData(lat, lng) {
            console.log('‚òÄÔ∏è Fetching climate data for:', lat, lng);
            
            try {
                // Use a date from a week ago to ensure data availability
                const testDate = new Date();
                testDate.setDate(testDate.getDate() - 7);
                const dateStr = testDate.toISOString().split('T')[0].replace(/-/g, '');
                
                const url = `${API_CONFIG.ENDPOINTS.NASA_POWER}?parameters=T2M,RH2M,ALLSKY_SFC_SW_DWN&community=RE&longitude=${lng}&latitude=${lat}&start=${dateStr}&end=${dateStr}&format=JSON`;
                console.log('üì° NASA POWER request:', url);
                
                const response = await fetch(url);
                console.log('üìä NASA POWER response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`NASA POWER API error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ NASA POWER data received:', data);
                
                // NASA returns -999 for missing data, filter these out
                const solar = data.properties?.parameter?.ALLSKY_SFC_SW_DWN?.[dateStr];
                const temp = data.properties?.parameter?.T2M?.[dateStr];
                const humidity = data.properties?.parameter?.RH2M?.[dateStr];
                
                const climateInfo = {
                    solarRadiation: (solar && solar !== -999) ? solar : null,
                    nasaTemperature: (temp && temp !== -999) ? temp : null,
                    nasaHumidity: (humidity && humidity !== -999) ? humidity : null,
                    date: dateStr
                };
                
                console.log('üéØ Climate data processed:', climateInfo);
                return climateInfo;
                
            } catch (error) {
                console.error('üí• NASA POWER fetch error:', error.message);
                return { solarRadiation: null, climateComfort: null };
            }
        }
        
        // Mock air quality based on location (fallback when real AQI fails)
        async function fetchAQI(lat, lon) {
          console.log('üå¨Ô∏è Generating air quality data for:', lat, lon);
          
          // Simple location-based PM2.5 estimation
          // Urban areas (near cities) = higher pollution
          // Rural/elevated areas = lower pollution
          
          const cityDistances = {
            delhi: Math.sqrt((lat - 28.6)** 2 + (lon - 77.2)** 2),
            mumbai: Math.sqrt((lat - 19.1)** 2 + (lon - 72.9)** 2),
            bangalore: Math.sqrt((lat - 12.97)** 2 + (lon - 77.59)** 2)
          };
          
          const nearestCityDistance = Math.min(...Object.values(cityDistances));
          
          // Base AQI: higher near cities, lower in rural areas
          let baseAQI = Math.max(10, 120 - (nearestCityDistance * 200));
          
          // Add some randomness for realism
          const randomFactor = 0.8 + (Math.random() * 0.4); // 0.8 to 1.2
          const aqi = Math.round(baseAQI * randomFactor);
          
          console.log('üéØ Estimated AQI value:', aqi);
          
          return { value: aqi };
        }

        // Compatibility wrapper
        async function fetchAirQuality(lat, lon) {
          return fetchAQI(lat, lon);
        }


        // Fetch elevation using Open-Elevation API
        async function fetchElevation(lat, lng) {
            console.log('‚õ∞Ô∏è Fetching elevation for:', lat, lng);
            
            const response = await fetch(
                `https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`
            );
            
            console.log('üìä Elevation response status:', response.status);
            
            if (!response.ok) throw new Error('Open-Elevation API error');
            
            const data = await response.json();
            console.log('‚úÖ Elevation data:', data.results[0]);
            
            return data.results[0];
        }

        // Calculate sustainability score using research-based framework (0-100)
        function calculateSustainabilityScore(greenData, airData, elevationData, weatherData = {}, climateData = {}, noiseData = {}, biodiversityData = {}, healthcareData = {total: 0}, educationData = {total: 0}, transportData = {total: 0}, servicesData = {total: 0}) {
            console.log('üî¨ Starting research-based sustainability calculation...');
            
            let totalScore = 0;
            
            // === ENVIRONMENTAL HEALTH (40% total weight) ===
            
            // Air Quality Score (15% weight) - WHO/EPA research-based
            let airScore = 0;
            const aqi = airData?.value;
            if (aqi !== null && aqi !== undefined) {
                if (aqi <= 50) airScore = 15;        // Good (WHO guideline)
                else if (aqi <= 100) airScore = 12;  // Moderate
                else if (aqi <= 150) airScore = 8;   // Unhealthy for sensitive
                else if (aqi <= 200) airScore = 4;   // Unhealthy
                else airScore = 0;                   // Very unhealthy+
            }
            totalScore += airScore;
            console.log(`üå¨Ô∏è Air Quality: ${airScore.toFixed(1)}/15 (AQI: ${aqi})`);
            
            // Green Space Access (12% weight) - 3-30-300 rule research
            const greenDensity = greenData.count;
            let greenScore = 0;
            if (greenDensity >= 15) greenScore = 12;      // Excellent (WHO standard)
            else if (greenDensity >= 10) greenScore = 10; // Good
            else if (greenDensity >= 5) greenScore = 7;   // Moderate
            else if (greenDensity >= 2) greenScore = 5;   // Poor
            else greenScore = Math.max(0, greenDensity * 2); // Very poor
            
            totalScore += greenScore;
            console.log(`üå≥ Green Spaces: ${greenScore.toFixed(1)}/12 (${greenDensity} features/km¬≤)`);
            
            // Water Body Access (3% weight) - Blue-green infrastructure research
            const waterCount = greenData.waterCount || 0;
            let waterScore = 0;
            if (waterCount >= 3) waterScore = 3;      // Excellent water access
            else if (waterCount >= 2) waterScore = 2; // Good
            else if (waterCount >= 1) waterScore = 1; // Moderate
            else waterScore = 0;                      // No water access
            
            totalScore += waterScore;
            console.log(`üíß Water Bodies: ${waterScore.toFixed(1)}/3 (${waterCount} water features/km¬≤)`);
            
            // Noise Pollution Score (3% weight) - Lower noise = higher score
            let noiseScore = 0;
            const noiseLevel = noiseData?.noiseLevel;
            if (noiseLevel !== null && noiseLevel !== undefined) {
                if (noiseLevel <= 20) noiseScore = 3;      // Very quiet
                else if (noiseLevel <= 40) noiseScore = 2; // Quiet
                else if (noiseLevel <= 60) noiseScore = 1; // Moderate noise
                else noiseScore = 0;                       // High noise
            }
            
            totalScore += noiseScore;
            console.log(`üîä Noise Pollution: ${noiseScore.toFixed(1)}/3 (noise level: ${noiseLevel})`);
            
            // Biodiversity Score (2% weight) - Protected areas and natural spaces
            let biodiversityScore = 0;
            const protectedAreas = biodiversityData?.protectedAreas || 0;
            const naturalAreas = biodiversityData?.naturalAreas || 0;
            const totalBioFeatures = protectedAreas + naturalAreas;
            
            if (totalBioFeatures >= 3) biodiversityScore = 2;      // Excellent biodiversity
            else if (totalBioFeatures >= 2) biodiversityScore = 1.5; // Good
            else if (totalBioFeatures >= 1) biodiversityScore = 1;   // Moderate
            else biodiversityScore = 0;                              // Poor
            
            totalScore += biodiversityScore;
            console.log(`üåø Biodiversity: ${biodiversityScore.toFixed(1)}/2 (${totalBioFeatures} protected/natural areas)`);
            
            // Climate Comfort (10% weight) - Heat stress research
            let climateScore = 0;
            const temperature = weatherData?.temperature;
            const humidity = weatherData?.humidity;
            
            if (temperature !== null && temperature !== undefined) {
                // Optimal range 18-26¬∞C (thermal comfort research)
                if (temperature >= 18 && temperature <= 26) {
                    climateScore += 5;
                } else if (temperature >= 15 && temperature <= 30) {
                    climateScore += 3;
                } else if (temperature >= 10 && temperature <= 35) {
                    climateScore += 1;
                }
            }
            
            if (humidity !== null && humidity !== undefined) {
                // Optimal range 40-60% (comfort research)
                if (humidity >= 40 && humidity <= 60) {
                    climateScore += 5;
                } else if (humidity >= 30 && humidity <= 70) {
                    climateScore += 3;
                } else if (humidity >= 20 && humidity <= 80) {
                    climateScore += 1;
                }
            }
            
            totalScore += climateScore;
            console.log(`üå°Ô∏è Climate Comfort: ${climateScore.toFixed(1)}/10 (${temperature}¬∞C, ${humidity}%)`);
            
            // === SOCIAL INFRASTRUCTURE (35% total weight) ===
            
            // Healthcare Access (15% weight) - WHO urban health standards
            const healthcareFacilities = healthcareData?.total || 0;
            let healthcareScore = 0;
            if (healthcareFacilities >= 10) healthcareScore = 15;      // WHO urban standard
            else if (healthcareFacilities >= 7) healthcareScore = 12;  // Good
            else if (healthcareFacilities >= 4) healthcareScore = 9;   // Moderate
            else if (healthcareFacilities >= 1) healthcareScore = 6;   // Poor
            else healthcareScore = 0;                                  // Very poor
            
            totalScore += healthcareScore;
            console.log(`üè• Healthcare: ${healthcareScore.toFixed(1)}/15 (${healthcareFacilities} facilities/2km)`);
            
            // Education Access (10% weight) - UNESCO ESD goals
            const educationFacilities = educationData?.total || 0;
            let educationScore = 0;
            if (educationFacilities >= 8) educationScore = 10;      // Excellent diversity
            else if (educationFacilities >= 5) educationScore = 8;  // Good
            else if (educationFacilities >= 3) educationScore = 6;  // Moderate
            else if (educationFacilities >= 1) educationScore = 4;  // Poor
            else educationScore = 0;                                // Very poor
            
            totalScore += educationScore;
            console.log(`üè´ Education: ${educationScore.toFixed(1)}/10 (${educationFacilities} facilities/2km)`);
            
            // Public Transport (10% weight) - TOD research (400m rule)
            const transportStops = transportData?.total || 0;
            let transportScore = 0;
            if (transportStops >= 15) transportScore = 10;      // Excellent connectivity
            else if (transportStops >= 10) transportScore = 8;  // Good
            else if (transportStops >= 5) transportScore = 6;   // Moderate
            else if (transportStops >= 2) transportScore = 4;   // Poor
            else if (transportStops >= 1) transportScore = 2;   // Very poor
            else transportScore = 0;                            // No access
            
            totalScore += transportScore;
            console.log(`üöå Transport: ${transportScore.toFixed(1)}/10 (${transportStops} stops/1.5km)`);
            
            // === ECONOMIC SUSTAINABILITY (25% total weight) ===
            
            // Essential Services (15% weight) - 15-minute city research
            const essentialServices = servicesData?.total || 0;
            let servicesScore = 0;
            if (essentialServices >= 20) servicesScore = 15;      // 15-minute city standard
            else if (essentialServices >= 15) servicesScore = 12; // Good
            else if (essentialServices >= 10) servicesScore = 9;  // Moderate
            else if (essentialServices >= 5) servicesScore = 6;   // Poor
            else if (essentialServices >= 1) servicesScore = 3;   // Very poor
            else servicesScore = 0;                               // No access
            
            totalScore += servicesScore;
            console.log(`üè¶ Services: ${servicesScore.toFixed(1)}/15 (${essentialServices} services/1.5km)`);
            
            // Energy Potential (10% weight) - Renewable energy transition research
            let energyScore = 0;
            const solarRadiation = climateData?.solarRadiation;
            if (solarRadiation !== null && solarRadiation !== undefined) {
                // Based on solar PV potential research
                if (solarRadiation >= 6) energyScore = 10;      // Excellent solar potential
                else if (solarRadiation >= 4.5) energyScore = 8; // Good
                else if (solarRadiation >= 3) energyScore = 6;   // Moderate
                else if (solarRadiation >= 2) energyScore = 4;   // Poor
                else energyScore = 2;                            // Very poor
            }
            
            totalScore += energyScore;
            console.log(`‚òÄÔ∏è Energy Potential: ${energyScore.toFixed(1)}/10 (${solarRadiation} kWh/m¬≤/day)`);
            
            console.log(`üéØ Research-based Sustainability Score: ${totalScore.toFixed(1)}/100`);
            console.log(`üìä Breakdown: Environmental(${(airScore + greenScore + climateScore).toFixed(1)}/40) + Social(${(healthcareScore + educationScore + transportScore).toFixed(1)}/35) + Economic(${(servicesScore + energyScore).toFixed(1)}/25)`);
            
            return Math.round(totalScore);
        }

        // UI Event Handlers
        document.getElementById('help-btn').addEventListener('click', () => {
            document.getElementById('help-popup').style.display = 'block';
        });
        
        document.getElementById('basemap-btn').addEventListener('click', () => {
            document.getElementById('basemap-popup').style.display = 'block';
        });
        
        document.getElementById('toggle-clicks').addEventListener('click', () => {
            showingPreviousClicks = !showingPreviousClicks;
            const btn = document.getElementById('toggle-clicks');
            
            if (showingPreviousClicks) {
                btn.classList.add('active');
                btn.textContent = 'üëÅÔ∏è Hide';
                updatePreviousClicksList();
                showPreviousClicksOnMap();
            } else {
                btn.classList.remove('active');
                btn.textContent = 'üëÅÔ∏è History';
                hidePreviousClicksOnMap();
            }
        });
        
        function closePopup(popupId) {
            document.getElementById(popupId).style.display = 'none';
        }
        
        function changeBasemap(type) {
            if (type === 'satellite') {
                map.setStyle({
                    version: 8,
                    sources: {
                        'satellite': {
                            type: 'raster',
                            tiles: ['https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'],
                            tileSize: 256
                        }
                    },
                    layers: [{ id: 'satellite', type: 'raster', source: 'satellite' }]
                });
            } else {
                map.setStyle({
                    version: 8,
                    sources: {
                        'osm': {
                            type: 'raster',
                            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: '¬© OpenStreetMap contributors'
                        }
                    },
                    layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
                });
            }
            closePopup('basemap-popup');
        }
        
        function updatePreviousClicksList() {
            const listDiv = document.getElementById('clicks-list');
            if (previousClicks.length === 0) {
                listDiv.innerHTML = '<p style="opacity: 0.7;">No previous analyses yet</p>';
                return;
            }
            
            listDiv.innerHTML = previousClicks.map((click, index) => {
                const scoreColor = getScoreColor(click.score);
                const scoreCategory = getScoreCategory(click.score);
                return `<div class="click-item" onclick="flyToLocation(${click.lat}, ${click.lng})" style="border-left: 4px solid ${scoreColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong style="color: ${scoreColor};">Score: ${click.score}/100</strong>
                        <small style="opacity: 0.7;">${scoreCategory}</small>
                    </div>
                    <small>${click.lat}, ${click.lng} ‚Ä¢ ${click.timestamp}</small>
                </div>`;
            }).join('');
        }
        
        function flyToLocation(lat, lng) {
            map.flyTo({ center: [lng, lat], zoom: 12 });
        }
        
        function getScoreColor(score) {
            if (score >= 80) return '#4CAF50';      // Green - Excellent
            else if (score >= 70) return '#8BC34A'; // Light Green - Very Good
            else if (score >= 60) return '#CDDC39'; // Lime - Good
            else if (score >= 50) return '#FFC107'; // Amber - Moderate
            else if (score >= 40) return '#FF9800'; // Orange - Poor
            else if (score >= 30) return '#FF5722'; // Deep Orange - Very Poor
            else return '#F44336';                  // Red - Critical
        }
        
        function getScoreCategory(score) {
            if (score >= 80) return 'Excellent';
            else if (score >= 70) return 'Very Good';
            else if (score >= 60) return 'Good';
            else if (score >= 50) return 'Moderate';
            else if (score >= 40) return 'Poor';
            else if (score >= 30) return 'Very Poor';
            else return 'Critical';
        }
        
        function showPreviousClicksOnMap() {
            console.log('üó∫Ô∏è Showing previous clicks on map:', previousClicks.length);
            
            previousClicks.forEach((click, index) => {
                const lat = parseFloat(click.lat);
                const lng = parseFloat(click.lng);
                const scoreColor = getScoreColor(click.score);
                const scoreCategory = getScoreCategory(click.score);
                
                // Create marker element with score-based color
                const markerEl = document.createElement('div');
                markerEl.className = 'previous-click-marker';
                markerEl.style.cssText = `
                    width: 28px;
                    height: 28px;
                    border-radius: 50%;
                    background: ${scoreColor};
                    border: 3px solid white;
                    box-shadow: 0 3px 6px rgba(0,0,0,0.4);
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 11px;
                    font-weight: bold;
                    text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
                    transition: transform 0.2s ease;
                `;
                markerEl.textContent = click.score;
                
                // Add hover effect
                markerEl.addEventListener('mouseenter', () => {
                    markerEl.style.transform = 'scale(1.2)';
                });
                markerEl.addEventListener('mouseleave', () => {
                    markerEl.style.transform = 'scale(1)';
                });
                
                // Create marker
                const marker = new maplibregl.Marker(markerEl)
                    .setLngLat([lng, lat])
                    .addTo(map);
                
                // Enhanced popup with more details
                const popup = new maplibregl.Popup({ offset: 30 })
                    .setHTML(`
                        <div style="text-align: center; min-width: 150px;">
                            <div style="background: ${scoreColor}; color: white; padding: 5px; border-radius: 4px; margin-bottom: 8px;">
                                <strong>${click.score}/100 - ${scoreCategory}</strong>
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                <div><strong>Location:</strong> ${click.lat}, ${click.lng}</div>
                                <div><strong>Analyzed:</strong> ${click.timestamp}</div>
                                <div style="margin-top: 5px; font-size: 11px;">
                                    Green: ${click.greenCount} | AQI: ${click.aqi || 'N/A'}<br>
                                    Healthcare: ${click.healthcare} | Transport: ${click.transport}
                                </div>
                            </div>
                        </div>
                    `);
                
                markerEl.addEventListener('click', () => {
                    popup.addTo(map).setLngLat([lng, lat]);
                });
                
                previousClickMarkers.push(marker);
            });
        }
        
        function hidePreviousClicksOnMap() {
            console.log('üó∫Ô∏è Hiding previous clicks from map');
            
            previousClickMarkers.forEach(marker => {
                marker.remove();
            });
            previousClickMarkers = [];
        }
        
        // Update dashboard panels with data
        function displayResults(score, greenData, airData, elevationData, weatherData = {}, climateData = {}, noiseData = {}, biodiversityData = {}, healthcareData = {}, educationData = {}, transportData = {}, servicesData = {}, lat, lng) {
            const aqi = airData?.value;
            const temperature = weatherData?.temperature;
            const humidity = weatherData?.humidity;
            const solarRadiation = climateData?.solarRadiation;
            
            // Update overall score
            const scoreEl = document.getElementById('overall-score');
            const statusEl = document.getElementById('score-status');
            scoreEl.textContent = score;
            scoreEl.className = `overall-score ${getScoreClass(score)}`;
            statusEl.textContent = `${getScoreCategory(score)} ‚Ä¢ ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            
            // Update Air Quality
            document.getElementById('aqi-value').textContent = aqi || '--';
            updateBar('aqi-bar', aqi ? Math.max(0, 100 - aqi) : 0);
            
            // Update Climate
            document.getElementById('temp-value').textContent = temperature ? `${temperature.toFixed(1)}¬∞C` : '--¬∞C';
            document.getElementById('humidity-value').textContent = humidity ? `${humidity}%` : '--%';
            
            // Update Green Spaces
            document.getElementById('green-value').textContent = greenData.count || '--';
            updateBar('green-bar', Math.min(100, (greenData.count / 15) * 100));
            document.getElementById('water-value').textContent = greenData.waterCount || '--';
            
            // Update Healthcare
            const healthTotal = healthcareData?.total || 0;
            document.getElementById('healthcare-value').textContent = healthTotal;
            updateBar('healthcare-bar', Math.min(100, (healthTotal / 10) * 100));
            
            // Update Education
            const eduTotal = educationData?.total || 0;
            document.getElementById('education-value').textContent = eduTotal;
            updateBar('education-bar', Math.min(100, (eduTotal / 8) * 100));
            document.getElementById('transport-value').textContent = transportData?.total || '--';
            
            // Update Services
            const servicesTotal = servicesData?.total || 0;
            document.getElementById('services-value').textContent = servicesTotal;
            updateBar('services-bar', Math.min(100, (servicesTotal / 20) * 100));
            
            // Update Energy
            document.getElementById('energy-value').textContent = solarRadiation ? `${solarRadiation.toFixed(1)} kWh/m¬≤` : '-- kWh/m¬≤';
            updateBar('energy-bar', solarRadiation ? Math.min(100, (solarRadiation / 6) * 100) : 0);
        }
        
        function updateBar(barId, percentage) {
            document.getElementById(barId).style.width = `${percentage}%`;
        }
        
        function getScoreClass(score) {
            if (score >= 80) return 'score-excellent';
            else if (score >= 60) return 'score-good';
            else if (score >= 40) return 'score-fair';
            else if (score >= 20) return 'score-poor';
            else return 'score-critical';
        }
        // Initialize previous clicks on load
        updatePreviousClicksList();
        
        // Show previous clicks on map if toggle is active
        if (showingPreviousClicks) {
            showPreviousClicksOnMap();
        }
        
        // Close popups when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('popup-overlay')) {
                e.target.style.display = 'none';
            }
        });
    </script>
</body>
</html>