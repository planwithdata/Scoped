<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoped - Sustainability Click POC</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #container { display: flex; height: 100vh; }
        #map { flex: 1; }
        #sidebar { width: 300px; padding: 20px; background: #f5f5f5; overflow-y: auto; }
        #location-btn { margin-bottom: 10px; padding: 10px; background: #007cbf; color: white; border: none; cursor: pointer; }
        .score { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .loading { color: #666; font-style: italic; }
        .error { color: #d32f2f; }
    </style>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        <div id="sidebar">
            <button id="location-btn">üìç Go to My Location</button>
            <h3>Sustainability Score</h3>
            <p>Click anywhere on the map to analyze sustainability metrics for that location.</p>
            <div id="results">
                <p><em>Click on the map to get started...</em></p>
            </div>
            <hr>
            <small>
                <strong>Note:</strong> This POC uses free APIs with rate limits:
                <br>‚Ä¢ OSM tiles: demo use only
                <br>‚Ä¢ Overpass API: ~10k queries/day
                <br>‚Ä¢ OpenAQ: 2000 requests/hour
            </small>
        </div>
    </div>

    <script>
        // Initialize map with India default center
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors'
                    }
                },
                layers: [{
                    id: 'osm',
                    type: 'raster',
                    source: 'osm'
                }]
            },
            center: [77.2, 28.6], // Delhi, India
            zoom: 10
        });

        // Go to user location
        document.getElementById('location-btn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    map.flyTo({
                        center: [position.coords.longitude, position.coords.latitude],
                        zoom: 12
                    });
                });
            }
        });

        // Handle map clicks
        map.on('click', async (e) => {
            const { lng, lat } = e.lngLat;
            
            // Show loading state
            document.getElementById('results').innerHTML = '<div class="loading">Analyzing location...</div>';
            
            try {
                // Fetch all data in parallel
                const [greenData, airData, elevationData] = await Promise.all([
                    fetchGreenSpaces(lat, lng),
                    fetchAQI(lat, lng),
                    fetchElevation(lat, lng)
                ]);

                // Calculate sustainability score (0-100)
                const score = calculateSustainabilityScore(greenData, airData, elevationData);
                
                // Display results
                displayResults(score, greenData, airData, elevationData, lat, lng);
                
                // Add popup on map
                new maplibregl.Popup()
                    .setLngLat([lng, lat])
                    .setHTML(`<strong>Sustainability Score: ${score}/100</strong>`)
                    .addTo(map);
                    
            } catch (error) {
                document.getElementById('results').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        });

        // Fetch green spaces using Overpass API
        async function fetchGreenSpaces(lat, lng) {
            console.log('üå≥ Fetching green spaces for:', lat, lng);
            
            const radius = 1000; // 1km radius
            const query = `
                [out:json][timeout:25];
                (
                  way["landuse"="forest"](around:${radius},${lat},${lng});
                  way["leisure"="park"](around:${radius},${lat},${lng});
                  way["natural"="wood"](around:${radius},${lat},${lng});
                  way["landuse"="grass"](around:${radius},${lat},${lng});
                );
                out geom;
            `;
            
            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query
            });
            
            console.log('üìä Overpass response status:', response.status);
            
            if (!response.ok) throw new Error('Overpass API error');
            
            const data = await response.json();
            console.log('‚úÖ Green spaces found:', data.elements.length);
            
            return {
                count: data.elements.length,
                types: [...new Set(data.elements.map(el => el.tags?.landuse || el.tags?.leisure || el.tags?.natural))]
            };
        }

        // OpenAQ API configuration - requires API key for v3
        const OPENAQ_API_KEY = "e43a81a8bc684ff151297a85a886fa0135690ee07d8392ef201baca1f2f97de3"; // Set your API key here: "YOUR-OPENAQ-API-KEY"
        
        // Fetch nearest PM2.5 using OpenAQ
        async function fetchAQI(lat, lon) {
          console.log('üå¨Ô∏è Fetching air quality data for:', lat, lon);
          
          if (!OPENAQ_API_KEY) {
            console.warn('‚ö†Ô∏è OpenAQ API key not set. Get one from: https://openaq.org/');
            return { value: null, error: 'API key required' };
          }
          
          try {
            const url = `https://api.openaq.org/v3/parameters/2/latest?coordinates=${lat},${lon}&radius=25000&limit=10`;
            console.log('üì° OpenAQ request:', url);
            
            const res = await fetch(url, {
              headers: {
                'X-API-Key': OPENAQ_API_KEY
              }
            });
            
            console.log('üìä OpenAQ response status:', res.status);
            
            if (!res.ok) {
              const errorText = await res.text();
              console.error('‚ùå OpenAQ API error:', res.status, errorText);
              return { value: null, error: `API error: ${res.status}` };
            }
            
            const data = await res.json();
            console.log('‚úÖ OpenAQ data received:', data);
            
            if (!data.results || data.results.length === 0) {
              console.warn('‚ö†Ô∏è No air quality data found for this location');
              return { value: null, error: 'No data available' };
            }
            
            const pm25 = data.results[0].value;
            console.log('üéØ PM2.5 value:', pm25);
            
            return { value: pm25 };
          } catch(err) {
            console.error('üí• OpenAQ fetch error:', err);
            return { value: null, error: err.message };
          }
        }

        // Compatibility wrapper
        async function fetchAirQuality(lat, lon) {
          return fetchAQI(lat, lon);
        }


        // Fetch elevation using Open-Elevation API
        async function fetchElevation(lat, lng) {
            console.log('‚õ∞Ô∏è Fetching elevation for:', lat, lng);
            
            const response = await fetch(
                `https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`
            );
            
            console.log('üìä Elevation response status:', response.status);
            
            if (!response.ok) throw new Error('Open-Elevation API error');
            
            const data = await response.json();
            console.log('‚úÖ Elevation data:', data.results[0]);
            
            return data.results[0];
        }

        // Calculate simple sustainability score (0-100)
        function calculateSustainabilityScore(greenData, airData, elevationData) {
            let score = 50; // Base score
            
            // Green spaces factor (0-30 points)
            const greenScore = Math.min(greenData.count * 3, 30);
            score += greenScore;
            
            // Air quality factor (-20 to +20 points)
            const pm25 = airData?.pm25;
            if (pm25 !== null && pm25 !== undefined) {
                if (pm25 < 12) score += 20;      // WHO good
                else if (pm25 < 35) score += 10; // WHO moderate
                else if (pm25 < 55) score -= 5;  // WHO unhealthy
                else score -= 20;                // WHO very unhealthy
            }
            
            // Elevation bonus (higher = cleaner air, max 10 points)
            if (elevationData?.elevation) {
                score += Math.min(elevationData.elevation / 100, 10);
            }
            
            return Math.max(0, Math.min(100, Math.round(score)));
        }

        // Display results in sidebar
        function displayResults(score, greenData, airData, elevationData, lat, lng) {
            const pm25 = airData?.pm25;
            const elevation = elevationData?.elevation;
            
            document.getElementById('results').innerHTML = `
                <div class="score" style="color: ${score > 70 ? 'green' : score > 40 ? 'orange' : 'red'}">
                    ${score}/100
                </div>
                <p><strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}</p>
                
                <h4>üå≥ Green Spaces</h4>
                <p>${greenData.count} features found within 1km</p>
                <p>Types: ${greenData.types.join(', ') || 'None detected'}</p>
                
                <h4>üå¨Ô∏è Air Quality</h4>
                <p>PM2.5: ${pm25 ? pm25.toFixed(1) + ' Œºg/m¬≥' : 'No data available'}</p>
                ${pm25 ? `<p>Status: ${pm25 < 12 ? 'Good' : pm25 < 35 ? 'Moderate' : pm25 < 55 ? 'Unhealthy' : 'Very Unhealthy'}</p>` : ''}
                
                <h4>‚õ∞Ô∏è Elevation</h4>
                <p>${elevation ? elevation.toFixed(0) + 'm above sea level' : 'No data available'}</p>
                
                <hr>
                <small><em>Score factors: Green spaces (0-30), Air quality (-20 to +20), Elevation (0-10)</em></small>
            `;
        }
    </script>
</body>
</html>